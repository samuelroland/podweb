/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package podweb;

import java.nio.file.Path;
import java.util.Collections;
import java.util.Map;

import gg.jte.ContentType;
import gg.jte.TemplateEngine;
import gg.jte.resolve.DirectoryCodeResolver;
import io.javalin.Javalin;
import io.javalin.http.staticfiles.Location;
import io.javalin.rendering.template.JavalinJte;
import podweb.models.*;
import podweb.controllers.*;

public class App {
    static final int PORT = 7000;
    static Javalin app;

    public static void main(String[] args) {
        System.out.println("Podweb server has started...");
        app = setupApp().start(PORT);
    }

    // Separated method to easily test the server
    public static Javalin setupApp() {
        JavalinJte.init(createTemplateEngine());

        // Search static files inside the default folder in dev and just a "static"
        // folder in production
        Javalin app = Javalin.create(config -> {
            String folder = "src/main/static";
            if (System.getenv("PODWEB_PRODUCTION") != null) {
                folder = "static";
            }
            config.staticFiles.add(folder, Location.EXTERNAL);
        });

        // TODO: Defines routes
        PodcastsController podcastsController = new PodcastsController();
        app.get("/", podcastsController::index);
        app.get("/podcasts/{id}", podcastsController::detailPodcast);
        app.get("/search", podcastsController::search);
        return app;
    }

    // Configuration of JTE templates
    // Taken from the Javalin tutorials:
    // https://javalin.io/tutorials/jte#precompiling-templates
    private static TemplateEngine createTemplateEngine() {
        if (System.getenv("PODWEB_PRODUCTION") != null) {
            // Production mode, use precompiled classes loaded in the JAR
            return TemplateEngine.createPrecompiled(Path.of("jte-classes"), ContentType.Html);
        } else {
            // Dev mode, compile on the fly templates in the default folder src/main/jte
            DirectoryCodeResolver codeResolver = new DirectoryCodeResolver(Path.of("src", "main", "jte"));
            return TemplateEngine.create(codeResolver, ContentType.Html);
        }
    }
}
